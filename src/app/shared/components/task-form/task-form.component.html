<div class="task-detail">
  <div class="task-detail-header flex justify-between items-center mb-4">
    <div class="flex items-center">
      @if (showBackButton) {
        <button (click)="back.emit()" class="mr-2" aria-label="Atrás">
          <mat-icon>arrow_back</mat-icon>
        </button>
      }
    </div>
    <h3 class="text-lg font-semibold">Crear Nueva Tarea</h3>
    <div></div>
  </div>
  
  <form [formGroup]="taskForm" (ngSubmit)="onSubmit()">
    <div class="divider divider-vertical"></div>
    <div class="task-header">
      <input class="task-title-input font-medium text-lg mb-1"
             formControlName="title" 
             placeholder="Título de la tarea"
             [readonly]="shouldApplyRestrictions"
             required />
      @if (taskForm.get('title')?.touched && taskForm.get('title')?.invalid) {
        <div class="text-red-500 text-xs mt-1">El título es obligatorio.</div>
      }
    </div>
    
    <div class="full-width">
      <textarea class="textarea mb-4" 
                rows="1" 
                formControlName="description" 
                placeholder="Describe la tarea..."
                [readonly]="shouldApplyRestrictions"
                required></textarea>
      @if (taskForm.get('description')?.touched && taskForm.get('description')?.invalid) {
        <div class="text-red-500 text-xs mt-1">La descripción es obligatoria.</div>
      }
    </div>
    
    <!-- Sección de fecha y hora -->
    <div class="datetime-section mb-4">
      <div class="datetime-grid">
        <!-- Date picker -->
        <mat-form-field class="datetime-field">
          <mat-label>Fecha</mat-label>
          <input matInput [matDatepicker]="picker" 
                 [value]="taskForm.get('due_date')?.value || ''"
                 (dateChange)="onDateChange($event)"
                 (click)="picker.open()"
                 [readonly]="shouldApplyRestrictions"
                 required />
          <mat-datepicker-toggle matIconSuffix [for]="picker" 
                                [disabled]="shouldApplyRestrictions">
            <mat-icon matDatepickerToggleIcon>calendar_today</mat-icon>
          </mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          @if (taskForm.get('due_date')?.touched && taskForm.get('due_date')?.invalid) {
            <mat-error>La fecha límite es obligatoria.</mat-error>
          }
        </mat-form-field>
        
        <!-- Time picker para hora de inicio -->
        <mat-form-field class="datetime-field">
          <mat-label>Inicio</mat-label>
          <input matInput [matTimepicker]="startPicker" formControlName="time_start"
                 [readonly]="shouldApplyRestrictions">
          <mat-timepicker-toggle matIconSuffix [for]="startPicker"
                                [disabled]="shouldApplyRestrictions">
            <mat-icon matTimepickerToggleIcon>schedule</mat-icon>
          </mat-timepicker-toggle>
          <mat-timepicker #startPicker/>
        </mat-form-field>
        
        <!-- Tiempo estimado con intervalos de 15 minutos -->
        <mat-form-field class="datetime-field">
          <mat-label>Duración</mat-label>
          <mat-select formControlName="time_estimated" [disabled]="shouldApplyRestrictions">
            <mat-option value="15">15 min</mat-option>
            <mat-option value="30">30 min</mat-option>
            <mat-option value="45">45 min</mat-option>
            <mat-option value="60">1 hora</mat-option>
            <mat-option value="90">1 hora 30</mat-option>
            <mat-option value="120">2 horas</mat-option>
            <mat-option value="150">2 horas 30</mat-option>
            <mat-option value="180">3 horas</mat-option>
            <mat-option value="240">4 horas</mat-option>
          </mat-select>
          <mat-icon matSuffix>timer</mat-icon>
        </mat-form-field>
      </div>
    </div>
    
    <!-- Sección de prioridad, "urgente" e "importante" -->
    <div class="priority-section-container mb-4">
      <div class="priority-section">
        <div class="flex items-center justify-center gap-6">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" formControlName="is_urgent">
            <span class="text-sm font-medium">Urgente</span>
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" formControlName="is_important">
            <span class="text-sm font-medium">Importante</span>
          </label>
        </div>
      </div>
    </div>
    
    <div class="subtasks-section">
      <h3>Subtareas:</h3>
      @if (subtasks.controls.length > 0) {
        <ul class="subtasks-list">
          @for (subtask of subtasks.controls; track $index; let i = $index) {
            <li class="subtask-item" [formGroupName]="i">
              <input type="text" 
                     formControlName="title"
                     class="subtask-name" 
                     placeholder="Título de la subtarea"
                     [readonly]="shouldApplyRestrictions" />
              @if (!shouldApplyRestrictions) {
                <button type="button" 
                        class="remove-subtask-btn text-red-500 hover:text-red-700 text-sm"
                        (click)="removeSubtask(i)">
                  Eliminar
                </button>
              }
            </li>
          }
        </ul>
        @if (!shouldApplyRestrictions) {
          <button type="button" 
                  class="add-subtask-btn mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
                  (click)="addSubtask()">
            + Agregar subtarea
          </button>
        }
      } @else {
        <p class="no-subtasks-text text-gray-500 dark:text-gray-400 italic text-sm mt-2">
          No contiene subtareas
        </p>
        @if (!shouldApplyRestrictions) {
          <button type="button" 
                  class="add-subtask-btn mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium"
                  (click)="addSubtask()">
            + Agregar subtarea
          </button>
        }
      }
    </div>
    
    <!-- Botones de acción -->
    <div class="save-changes-section mt-6">
      <div class="flex gap-3">
        <button type="button" 
                class="cancel-btn flex-1 py-2 px-4 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                (click)="closeForm()">
          Cancelar
        </button>
        <button type="submit" 
                class="save-changes-btn flex-1 py-2 px-4 rounded-lg transition-colors"
                [disabled]="taskForm.invalid">
          Crear Tarea
        </button>
      </div>
    </div>
  </form>
</div>
